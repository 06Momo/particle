import streamlit as st
import openai
import os
import re

# =======================================================================
# 1. APIã‚­ãƒ¼ã®è¨­å®š (st.secretsã‹ã‚‰å®‰å…¨ã«èª­ã¿è¾¼ã‚€)
# -----------------------------------------------------------------------
# Streamlit Cloudã§ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹å ´åˆã€APIã‚­ãƒ¼ã¯ st.secrets["openai"]["api_key"]
# ã‹ã‚‰è‡ªå‹•çš„ã«èª­ã¿è¾¼ã¾ã‚Œã¾ã™ã€‚ãƒ­ãƒ¼ã‚«ãƒ«ã§ãƒ†ã‚¹ãƒˆã™ã‚‹å ´åˆã¯ã€ç’°å¢ƒå¤‰æ•°
# ã¾ãŸã¯ç›´æ¥ os.environ["OPENAI_API_KEY"] = "sk-..." ãªã©ã§è¨­å®šãŒå¿…è¦ã§ã™ã€‚
# =======================================================================

try:
    # st.secrets ã‹ã‚‰ API ã‚­ãƒ¼ã‚’èª­ã¿è¾¼ã‚€
    openai.api_key = st.secrets["openai"]["api_key"]
except KeyError:
    # st.secrets ã«ã‚­ãƒ¼ãŒãªã„å ´åˆ (ãƒ­ãƒ¼ã‚«ãƒ«ãƒ†ã‚¹ãƒˆæ™‚ãªã©)
    st.error("ã‚¨ãƒ©ãƒ¼: OpenAI APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚")
    st.info("Streamlit Cloudã®Secretsã¾ãŸã¯ç’°å¢ƒå¤‰æ•°ã«'openai.api_key'ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚")
    st.stop()
except AttributeError:
    # openaiãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«ã‚ˆã£ã¦ã¯ client ã‚’ä½¿ç”¨
    pass
    
# æ–°ã—ã„ openai ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã® client å½¢å¼
try:
    client = openai.OpenAI(api_key=st.secrets["openai"]["api_key"])
except Exception as e:
    st.error(f"APIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ: {e}")
    st.stop()


# =======================================================================
# 2. ãƒ¡ã‚¤ãƒ³ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆAIã¸ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆé€ä¿¡ï¼‰
# -----------------------------------------------------------------------
def generate_kaiun_action(goal: str, anxiety: str):
    """
    ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å…¥åŠ›ã«åŸºã¥ãã€AIã«é–‹é‹ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’ç”Ÿæˆã•ã›ã‚‹é–¢æ•°
    """
    # ğŸŒŸ AIã«é€ã‚‹ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®è¨­è¨ˆ ğŸŒŸ
    system_prompt = """
    ã‚ãªãŸã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ°—åˆ†ã¨ç›®æ¨™ã‹ã‚‰ã€æœ€é©ãªã€Œä»Šæ—¥ã®é–‹é‹ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã€ã‚’ææ¡ˆã™ã‚‹ãƒã‚¸ãƒ†ã‚£ãƒ–ãªã‚¢ãƒ‰ãƒã‚¤ã‚¶ãƒ¼ã§ã™ã€‚
    ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®é‹æ°—ã‚’ä¸Šã’ã‚‹å…·ä½“çš„ãªè¡Œå‹•ã‚’ä¸€ã¤ææ¡ˆã—ã€ãªãœãã®è¡Œå‹•ãŒæœ‰åŠ¹ã‹ã‚’è§£èª¬ã—ã¦ãã ã•ã„ã€‚

    ã€åˆ¶ç´„æ¡ä»¶ã€‘
    1. å‡ºåŠ›ã¯ä»¥ä¸‹ã®2ã¤ã®é …ç›®ã®ã¿ã¨ã—ã¾ã™ã€‚
    2. ã€Œé–‹é‹ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã€ã¯å…·ä½“çš„ãªè¡Œå‹•ï¼ˆä¾‹: æ˜¼é£Ÿæ™‚ã«æ–°ã—ã„ãƒ«ãƒ¼ãƒˆã‚’æ­©ãï¼‰ã‚’ä¸€ã¤ã ã‘ææ¡ˆã—ã¦ãã ã•ã„ã€‚
    3. ã€Œè§£èª¬ã€ã¯ãƒã‚¸ãƒ†ã‚£ãƒ–ã§ãƒ¦ãƒ¼ãƒ¢ã‚¢ã‚’äº¤ãˆãŸãƒˆãƒ¼ãƒ³ã§ã€50æ–‡å­—ä»¥ä¸Š100æ–‡å­—ä»¥ä¸‹ã§è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚
    4. æ—¥æœ¬èªã§å¿œç­”ã—ã¦ãã ã•ã„ã€‚

    ã€å‡ºåŠ›ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã€‘
    é–‹é‹ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼š[å…·ä½“çš„ãªè¡Œå‹•]
    è§£èª¬ï¼š[ãƒã‚¸ãƒ†ã‚£ãƒ–ãªè§£èª¬æ–‡]
    """
    
    user_message = f"""
    ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å›ç­”ã€‘
    - ä»Šæ—¥ã®ç›®æ¨™ï¼š{goal}
    - ä»Šæ—¥ã®å°ã•ãªä¸å®‰ï¼š{anxiety}
    """

    try:
        response = client.chat.completions.create(
            model="gpt-3.5-turbo",  # åˆå¿ƒè€…å‘ã‘ã«å‡¦ç†ãŒé€Ÿãå®‰ä¾¡ãªãƒ¢ãƒ‡ãƒ«ã‚’æ¨å¥¨
            messages=[
                {"role": "system", "content": system_prompt},
                {"role": "user", "content": user_message}
            ],
            temperature=0.8,  # å‰µé€ æ€§ã‚’é«˜ã‚ã‚‹ãŸã‚ã«å°‘ã—é«˜ã‚ã«è¨­å®š
        )
        return response.choices[0].message.content
    except Exception as e:
        st.error(f"AIã‹ã‚‰ã®å¿œç­”å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {e}")
        return None

# =======================================================================
# 3. Streamlit UIã®æ§‹ç¯‰
# -----------------------------------------------------------------------
st.set_page_config(page_title="ä»Šæ—¥ã®é–‹é‹ã‚¢ã‚¯ã‚·ãƒ§ãƒ³è¨ºæ–­ ğŸ€", layout="centered")
st.title("ğŸ€ ä»Šæ—¥ã®é–‹é‹ã‚¢ã‚¯ã‚·ãƒ§ãƒ³è¨ºæ–­")
st.markdown("ä»Šæ—¥ã®æ°—åˆ†ã‚’å…¥åŠ›ã—ã¦ã€ã‚ãªãŸã ã‘ã®é‹æ°—ã‚’ä¸Šã’ã‚‹ãŸã‚ã®å…·ä½“çš„ãªè¡Œå‹•ã‚’AIã«è¨ºæ–­ã—ã¦ã‚‚ã‚‰ã„ã¾ã—ã‚‡ã†ï¼")
st.markdown("---")

# === è³ªå•ãƒ•ã‚©ãƒ¼ãƒ  ===
with st.form("kaiun_form", clear_on_submit=False):
    st.header("1. ä»Šæ—¥ã®æ°—åˆ†ã¨ç›®æ¨™ã‚’æ•™ãˆã¦ãã ã•ã„")
    
    goal = st.text_input("ğŸ¯ ä»Šæ—¥ã®ç›®æ¨™ï¼ˆä¾‹ï¼šé›†ä¸­åŠ›UPã€äººé–“é–¢ä¿‚ã‚’æ”¹å–„ã—ãŸã„ã€ãƒªãƒ©ãƒƒã‚¯ã‚¹ã—ãŸã„ï¼‰", 
                          value="é›†ä¸­åŠ›UP", max_chars=50)
    
    anxiety = st.text_input("ğŸ˜Ÿ ä»Šã®å°ã•ãªä¸å®‰ï¼ˆä¾‹ï¼šä»•äº‹ãŒç‰‡ä»˜ã‹ãªã„ã€å°‘ã—ç–²ã‚Œã¦ã„ã‚‹ã€ç‰¹ã«ãªã„ï¼‰", 
                             value="ä»•äº‹ãŒç‰‡ä»˜ã‹ãªã„", max_chars=50)
    
    submitted = st.form_submit_button("ğŸ”® é‹å‹¢ã‚’è¨ºæ–­ã™ã‚‹ï¼")

# === è¨ºæ–­çµæœã®è¡¨ç¤º ===
if submitted and goal and anxiety:
    with st.spinner("AIãŒã‚ãªãŸã®ä»Šæ—¥ã®é‹å‹¢ã‚’åˆ†æä¸­..."):
        result_text = generate_kaiun_action(goal, anxiety)
    
    if result_text:
        st.markdown("---")
        st.subheader("ğŸŒŸ ã‚ãªãŸã¸ã®ä»Šæ—¥ã®é–‹é‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ ğŸŒŸ")
        
        # AIã‹ã‚‰ã®å¿œç­”ã‚’è§£æã—ã€æ•´å½¢ã—ã¦è¡¨ç¤º
        try:
            # æ­£è¦è¡¨ç¾ã§ã€Œé–‹é‹ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã€ã¨ã€Œè§£èª¬ã€ã‚’æŠ½å‡º
            action_match = re.search(r"é–‹é‹ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼š(.+)", result_text)
            comment_match = re.search(r"è§£èª¬ï¼š(.+)", result_text)

            if action_match:
                action = action_match.group(1).strip()
                st.markdown(f"### â¡ï¸ é–‹é‹ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼š **{action}**")
            
            if comment_match:
                comment = comment_match.group(1).strip()
                st.info(comment)
            else:
                st.markdown(result_text) # æŠ½å‡ºã§ããªã‹ã£ãŸå ´åˆã¯ãã®ã¾ã¾è¡¨ç¤º

        except Exception as e:
            st.error(f"çµæœã®è§£æä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {e}")
            st.markdown(f"**AIã‹ã‚‰ã®ç”Ÿãƒ‡ãƒ¼ã‚¿:**\n{result_text}")

# =======================================================================
