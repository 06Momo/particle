import streamlit as st
import openai
import os
import re

# =======================================================================
# 1. APIキーの設定 (st.secretsから安全に読み込む)
# -----------------------------------------------------------------------
# Streamlit Cloudでデプロイする場合、APIキーは st.secrets["openai"]["api_key"]
# から自動的に読み込まれます。ローカルでテストする場合は、環境変数
# または直接 os.environ["OPENAI_API_KEY"] = "sk-..." などで設定が必要です。
# =======================================================================

try:
    # st.secrets から API キーを読み込む
    openai.api_key = st.secrets["openai"]["api_key"]
except KeyError:
    # st.secrets にキーがない場合 (ローカルテスト時など)
    st.error("エラー: OpenAI APIキーが設定されていません。")
    st.info("Streamlit CloudのSecretsまたは環境変数に'openai.api_key'を設定してください。")
    st.stop()
except AttributeError:
    # openaiライブラリのバージョンによっては client を使用
    pass
    
# 新しい openai ライブラリの client 形式
try:
    client = openai.OpenAI(api_key=st.secrets["openai"]["api_key"])
except Exception as e:
    st.error(f"APIクライアントの初期化に失敗しました: {e}")
    st.stop()


# =======================================================================
# 2. メインロジック（AIへのプロンプト送信）
# -----------------------------------------------------------------------
def generate_kaiun_action(goal: str, anxiety: str):
    """
    ユーザーの入力に基づき、AIに開運アクションを生成させる関数
    """
    # 🌟 AIに送るプロンプトの設計 🌟
    system_prompt = """
    あなたはユーザーの気分と目標から、最適な「今日の開運アクション」を提案するポジティブなアドバイザーです。
    ユーザーの運気を上げる具体的な行動を一つ提案し、なぜその行動が有効かを解説してください。

    【制約条件】
    1. 出力は以下の2つの項目のみとします。
    2. 「開運アクション」は具体的な行動（例: 昼食時に新しいルートを歩く）を一つだけ提案してください。
    3. 「解説」はポジティブでユーモアを交えたトーンで、50文字以上100文字以下で記述してください。
    4. 日本語で応答してください。

    【出力フォーマット】
    開運アクション：[具体的な行動]
    解説：[ポジティブな解説文]
    """
    
    user_message = f"""
    【ユーザーの回答】
    - 今日の目標：{goal}
    - 今日の小さな不安：{anxiety}
    """

    try:
        response = client.chat.completions.create(
            model="gpt-3.5-turbo",  # 初心者向けに処理が速く安価なモデルを推奨
            messages=[
                {"role": "system", "content": system_prompt},
                {"role": "user", "content": user_message}
            ],
            temperature=0.8,  # 創造性を高めるために少し高めに設定
        )
        return response.choices[0].message.content
    except Exception as e:
        st.error(f"AIからの応答取得中にエラーが発生しました: {e}")
        return None

# =======================================================================
# 3. Streamlit UIの構築
# -----------------------------------------------------------------------
st.set_page_config(page_title="今日の開運アクション診断 🍀", layout="centered")
st.title("🍀 今日の開運アクション診断")
st.markdown("今日の気分を入力して、あなただけの運気を上げるための具体的な行動をAIに診断してもらいましょう！")
st.markdown("---")

# === 質問フォーム ===
with st.form("kaiun_form", clear_on_submit=False):
    st.header("1. 今日の気分と目標を教えてください")
    
    goal = st.text_input("🎯 今日の目標（例：集中力UP、人間関係を改善したい、リラックスしたい）", 
                          value="集中力UP", max_chars=50)
    
    anxiety = st.text_input("😟 今の小さな不安（例：仕事が片付かない、少し疲れている、特にない）", 
                             value="仕事が片付かない", max_chars=50)
    
    submitted = st.form_submit_button("🔮 運勢を診断する！")

# === 診断結果の表示 ===
if submitted and goal and anxiety:
    with st.spinner("AIがあなたの今日の運勢を分析中..."):
        result_text = generate_kaiun_action(goal, anxiety)
    
    if result_text:
        st.markdown("---")
        st.subheader("🌟 あなたへの今日の開運メッセージ 🌟")
        
        # AIからの応答を解析し、整形して表示
        try:
            # 正規表現で「開運アクション」と「解説」を抽出
            action_match = re.search(r"開運アクション：(.+)", result_text)
            comment_match = re.search(r"解説：(.+)", result_text)

            if action_match:
                action = action_match.group(1).strip()
                st.markdown(f"### ➡️ 開運アクション： **{action}**")
            
            if comment_match:
                comment = comment_match.group(1).strip()
                st.info(comment)
            else:
                st.markdown(result_text) # 抽出できなかった場合はそのまま表示

        except Exception as e:
            st.error(f"結果の解析中にエラーが発生しました: {e}")
            st.markdown(f"**AIからの生データ:**\n{result_text}")

# =======================================================================
